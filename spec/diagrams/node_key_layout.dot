digraph G {
    #########
    # SETUP #
    #########

    compound = true
    fontname = "Helvetica"

    edge [
        colorscheme = "piyg11"
        color = black
        fontname = "Helvetica"
    ];

    node [
        shape = box
        colorscheme = "piyg11"
        style = filled
        fillcolor = 5
        color = black
        fontname = "Helvetica"
        color=2
        fontcolor=2
    ];

    graph [
        colorscheme="piyg11"
        color=10
        style = filled
        fontcolor=white
    ];

    ##############
    # FREE NODES #
    ##############

    invis_parent [style = invis]
    node_key [label = "Node Key\n🔑" color = 2  fontcolor = 2]
    content_key [label = "Content Key\n🗝" color=10 fontcolor = 10 fillcolor=7]

    ############
    # CLUSTERS #
    ############

    subgraph cluster_private_header {
        label = "Private Header"
        color=3

        skip_ratchet [label = "Skip Ratchet\n⚙️" color = blueviolet fontcolor = blueviolet fillcolor=lavender]
        bare_nf [label = "Bare Namefilter" shape = note]
        i_number [label = "i-number" shape = note]

        skip_ratchet -> bare_nf -> i_number [style=invis]
    }

    subgraph cluster_temporal_header {
        label = "Temporal Header"
        color = 3

        apps_header_key [label = "Apps Node Key\n🔑"]
        docs_header_key [label = "Documents Node Key\n🔑"]
        invis_header [style = invis]

        invis_header -> apps_header_key -> docs_header_key  [style=invis]
    }

    subgraph cluster_private_content {
        label = "Private Content"

        node [
            color=10
            fontcolor=10
            fillcolor=7
        ]

        metadata [shape = note]

        apps_content_key [label="Apps Content Key\n🗝"]
        docs_content_key [label="Documents Content Key\n🗝"]

        metadata -> apps_content_key -> docs_content_key [style=invis];
    }

    #########
    # EDGES #
    #########

    node_key:e -> content_key:n [
        label = "SHA3"
        style = dashed
        color = 3
        fontcolor = 3
        weight = 0.5
    ]

    node_key:w -> skip_ratchet:w [
        dir = back
        style = dashed
        label = "Derive"
        color = blueviolet
        fontcolor = blueviolet
    ]

    invis_parent -> node_key [color = lightgray weight = 10]
    content_key:s -> metadata [
        lhead = cluster_private_content
        color = 10
        weight = 18
    ]

    node_key -> skip_ratchet [lhead = cluster_private_header color = 3 weight=10]
    node_key -> invis_header [lhead = cluster_temporal_header color = 3]

    apps_header_key -> apps_content_key [
        penwidth = 3
        arrowtail = none
        dir = back
        style = dashed
    ]

    docs_content_key -> docs_header_key [
        penwidth = 3
        arrowhead = none
        style = dashed
    ]

    ################
    # LAYOUT HACKS #
    ################

    content_key:s -> invis_header:n [lhead=cluster_temporal_header style=invis]
    content_key:s -> skip_ratchet:n [lhead=cluster_temporal_header style=invis]
    skip_ratchet -> apps_header_key [lhead=cluster_private_header style=invis]
    apps_header_key -> skip_ratchet [style=invis]
}

