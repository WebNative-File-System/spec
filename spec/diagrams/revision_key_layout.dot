digraph G {

    #########
    # SETUP #
    #########

    compound = true
    fontname = "Helvetica"
    newrank = true

    edge [
        colorscheme = "piyg11"
        color = black
        fontname = "Helvetica"
    ]

    node [
        shape = box
        colorscheme = "piyg11"
        style = filled
        fillcolor = 5
        color = black
        fontname = "Helvetica"
        color=2
        fontcolor=2
    ]

    graph [
        colorscheme = "piyg11"
        style = "rounded,filled"
    ]

    #################
    # NODES & EDGES #
    #################

    invis_parent [style = invis]
    revision_key [label = "Revision Key\n🔑" color = 2  fontcolor = 2]
    content_key [label = "Content Key\n🗝" color=10 fontcolor = 10 fillcolor=7]

    subgraph cluster_node {
        label = "Private Node"
        color = 8
        fontcolor = 10

        node [
            color=10
            fontcolor=10
            fillcolor=7
        ]
        
        subgraph cluster_node_header {
            label = "Private Node Header"
            color = 3
            fontcolor = white

            node [
                color = 2
                fontcolor = 2
                fillcolor = 5
            ]

            skip_ratchet [
                label = "Skip Ratchet\n⚙️"
                color = blueviolet
                fontcolor = blueviolet
                fillcolor = lavender
            ]

            bare_namefilter [label = "Bare Namefilter" shape = note]
            i_number [label = "i-number" shape = note]

            skip_ratchet -> bare_namefilter -> i_number [style=invis]
        }

        subgraph cluster_apps {
            label = "Revision-encrypted"
            color = 3
            fontcolor = white
            node [
                color = 2
                fontcolor = 2
                fillcolor = 5
            ]

            apps_revision_key [label = "Apps Revision Key\n🔑"]
        }

        subgraph cluster_docs {
            label = "Revision-encrypted"
            color = 3
            fontcolor = white
            node [
                color = 2
                fontcolor = 2
                fillcolor = 5
            ]

            docs_revision_key [label = "Documents Revision Key\n🔑"]
        }

        metadata [shape = note]

        apps_content_key [label = "Apps Content Key\n🗝"]
        docs_content_key [label = "Documents Content Key\n🗝"]

        apps_revision_key -> apps_content_key [label = "Hash" color = 2 fontcolor = 2 style = dashed]
        docs_revision_key -> docs_content_key [label = "Hash" color = 2 fontcolor = 2 style = dashed]

        {rank=same apps_revision_key apps_content_key}
        {rank=same docs_revision_key docs_content_key}

        metadata -> apps_content_key -> docs_content_key [style = invis]
        metadata -> apps_revision_key -> docs_revision_key [style = invis]
    }

    invis_parent -> revision_key [
        color = lightgray
        weight = 10
    ]

    revision_key -> content_key [
        label = "Hash"
        style = dashed
        color = 2
        fontcolor = 2
    ]

    {rank=same revision_key content_key}

    content_key -> metadata [ lhead = cluster_node color = 10 ]

    revision_key -> skip_ratchet:e [
        label = "derive key"
        style = dashed
        dir = back
        color = blueviolet
        fontcolor = blueviolet
    ]

    revision_key -> skip_ratchet [lhead = cluster_node_header color = 2]
    revision_key -> apps_revision_key [lhead = cluster_apps color = 2]
    revision_key -> docs_revision_key [lhead = cluster_docs color = 2]
}
